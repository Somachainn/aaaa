<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam wallet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  :root{
    /* Blue & White Theme */
    --bg1:#eef2f3; --bg2:#8e9eab;
    --card:rgba(255, 255, 255, 0.9);
    --text:#0a192f; --muted:#546e7a;
    --brand:#0052cc; --brand2:#0041a3; --line:#d0d8e0;
    --ok:#28a745; --warn:#ffc107; --err:#dc3545;
    --maxw: 920px; --rad:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
    background:linear-gradient(135deg,#b8c6db,#f5f7fa);
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px 14px;
  }
  .app{ width:100%; max-width:450px; text-align:center; }
  
  /* Logo and Header Styles - matching the image */
  .logo-container{ 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    gap:15px; 
    margin-bottom:40px; 
  }
  .logo-container img{ 
    width:80px; 
    height:80px; 
    border-radius:50%;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
  }
  h1{ 
    margin:0; 
    font-size:3rem; 
    font-weight:800; 
    color:#1976d2; 
    text-shadow:1px 1px 2px rgba(0,0,0,0.1); 
  }
  
  /* Import Card Styles - exactly matching the image design */
  .import-card{
    background:rgba(255, 255, 255, 0.95);
    border:none;
    border-radius:24px;
    box-shadow:0 8px 32px rgba(0,0,0,0.12);
    padding:40px 30px;
    margin:0 auto;
    backdrop-filter:blur(10px);
    max-width:100%;
  }
  
  .form-group{
    margin-bottom:24px;
    text-align:left;
  }
  
  .form-label{
    display:block;
    font-size:18px;
    font-weight:700;
    color:#1976d2;
    margin-bottom:12px;
  }
  
  .form-input{
    width:100%;
    padding:20px;
    border:2px solid #e0e0e0;
    border-radius:16px;
    font-size:16px;
    background:#f8f9fa;
    color:#333;
    outline:none;
    transition:all 0.3s ease;
    font-family:'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
  }
  
  .form-input:focus{
    border-color:#1976d2;
    background:white;
    box-shadow:0 0 0 4px rgba(25,118,210,0.1);
  }
  
  .form-input::placeholder{
    color:#bbb;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  }
  
  .import-button{
    width:100%;
    padding:20px;
    background:#1976d2;
    color:white;
    border:none;
    border-radius:16px;
    font-size:18px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:1px;
    cursor:pointer;
    transition:all 0.3s ease;
    box-shadow:0 4px 16px rgba(25,118,210,0.3);
    margin-top:16px;
  }
  
  .import-button:hover{
    background:#1565c0;
    box-shadow:0 6px 20px rgba(25,118,210,0.4);
    transform:translateY(-2px);
  }
  
  .divider{
    margin:32px 0;
    text-align:center;
    position:relative;
  }
  
  .divider::before{
    content:'';
    position:absolute;
    top:50%;
    left:0;
    right:0;
    height:1px;
    background:#e0e0e0;
  }
  
  .divider-text{
    background:rgba(255, 255, 255, 0.95);
    padding:0 16px;
    color:#666;
    font-size:14px;
    font-weight:500;
  }
  
  .generate-link{
    text-align:center;
  }
  
  .generate-button{
    color:#1976d2;
    text-decoration:underline;
    background:none;
    border:none;
    cursor:pointer;
    font-size:16px;
    font-weight:600;
    transition:color 0.3s ease;
    text-transform:none;
    padding:0;
    width:auto;
    box-shadow:none;
  }
  
  .generate-button:hover{
    color:#1565c0;
    transform:none;
    box-shadow:none;
  }
  
  .note-text{
    font-size:12px;
    color:#666;
    margin-top:8px;
    line-height:1.4;
  }

  /* Key Display Modal */
  .key-modal{
    display:none;
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.5);
    z-index:1000;
    align-items:center;
    justify-content:center;
  }
  .key-modal.show{
    display:flex;
  }
  .key-modal-content{
    background:rgba(255, 255, 255, 0.95);
    border:none;
    border-radius:24px;
    box-shadow:0 8px 32px rgba(0,0,0,0.12);
    padding:40px 30px;
    max-width:500px;
    width:90%;
    max-height:90vh;
    overflow-y:auto;
    backdrop-filter:blur(10px);
  }
  .key-modal-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:30px;
  }
  .key-modal-title{
    font-size:1.8rem;
    font-weight:700;
    color:#1976d2;
    margin:0;
  }
  .key-modal-close{
    background:none;
    border:none;
    font-size:2rem;
    cursor:pointer;
    color:#666;
    padding:0;
    width:auto;
    height:auto;
    box-shadow:none;
    text-transform:none;
  }
  .key-modal-close:hover{
    color:#333;
    transform:none;
    box-shadow:none;
  }
  .key-display-group{
    margin-bottom:30px;
  }
  .key-display-label{
    display:block;
    font-size:16px;
    font-weight:700;
    color:#1976d2;
    margin-bottom:12px;
  }
  .key-display-container{
    position:relative;
    display:flex;
    align-items:center;
  }
  .key-display-input{
    width:100%;
    padding:15px 60px 15px 15px;
    border:2px solid #e0e0e0;
    border-radius:12px;
    font-size:14px;
    background:#f8f9fa;
    color:#333;
    font-family:'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    word-break:break-all;
    resize:none;
  }
  .copy-btn{
    position:absolute;
    right:10px;
    background:#1976d2;
    color:white;
    border:none;
    border-radius:8px;
    padding:8px 12px;
    font-size:12px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s ease;
    text-transform:uppercase;
    box-shadow:0 2px 8px rgba(25,118,210,0.3);
  }
  .copy-btn:hover{
    background:#1565c0;
    box-shadow:0 4px 12px rgba(25,118,210,0.4);
    transform:translateY(-1px);
  }
  .copy-btn.copied{
    background:#28a745;
    box-shadow:0 2px 8px rgba(40,167,69,0.3);
  }
  .warning-text{
    background:#fff3cd;
    border:1px solid #ffeaa7;
    border-radius:12px;
    padding:15px;
    margin:20px 0;
    color:#856404;
    font-size:14px;
    line-height:1.5;
  }
  .use-account-btn{
    width:100%;
    padding:15px;
    background:#28a745;
    color:white;
    border:none;
    border-radius:12px;
    font-size:16px;
    font-weight:700;
    text-transform:uppercase;
    cursor:pointer;
    transition:all 0.3s ease;
    box-shadow:0 4px 16px rgba(40,167,69,0.3);
  }
  .use-account-btn:hover{
    background:#218838;
    box-shadow:0 6px 20px rgba(40,167,69,0.4);
    transform:translateY(-2px);
  }

  /* Original styles for other sections - keeping all functionality */
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--rad);
    box-shadow:0 10px 30px rgba(0,0,0,0.1); padding:22px; margin:14px auto;
  }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  @media (max-width:820px){ .grid-2{ grid-template-columns:1fr; } }
  label{ display:block; text-align:left; margin:8px 0 6px; font-weight:600; color:var(--brand); }
  input,select,button{
    width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; font-size:1rem;
    background:#f8f9fa; color:var(--text); outline:none; transition:border-color .2s ease;
  }
  input:focus{ border-color:var(--brand); }
  button{
    background:var(--brand); color:#fff; font-weight:700; letter-spacing:.02em; border:none;
    box-shadow:0 4px 14px rgba(0,82,204,0.3); cursor:pointer; text-transform:uppercase; transition:all .2s ease;
  }
  button:hover{ background:var(--brand2); box-shadow:0 6px 18px rgba(0,65,163,0.4); transform:translateY(-2px); }
  button:disabled{ background:#b0bec5; cursor:not-allowed; box-shadow:none; transform:none; }
  .btn-secondary{ background:#6c757d; color:#fff; box-shadow:0 4px 14px rgba(0,0,0,0.1); }
  .btn-secondary:hover{ background:#5a6268; }
  .btn-danger{ background:var(--err); color:#fff; box-shadow:0 4px 14px rgba(220,53,69,0.3); }
  .btn-danger:hover{ background:#c82333; }
  .mono{
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    background:#e9ecef; padding:10px 12px; border-radius:12px; overflow-wrap:anywhere; color:#343a40;
  }
  .muted{ color:var(--muted); font-size:.92rem; }
  .balances{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .pill{ background:#e9ecef; border:1px solid var(--line); padding:8px 14px; border-radius:999px; font-weight:600; }
  .hidden{ display:none; }
  .send-wrap{ display:none; margin-top:16px; text-align:left; border-top:1px solid var(--line); padding-top:16px; }
  .send-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media (max-width:640px){ .send-row{ grid-template-columns:1fr; } }

  /* Enhanced Trade UI */
  .trade-card{ padding:0; overflow:hidden; }
  .trade-header{ display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--line); }
  .trade-header h3{ margin:0; font-size:1.2rem; }
  .trade-header .icon{ font-size:1.5rem; cursor:pointer; transition:color 0.3s ease; }
  .trade-header .icon:hover{ color:var(--brand); }
  .trade-asset-selector{ display:flex; align-items:center; justify-content:space-between; padding:16px 20px; background:#f8f9fa; }
  .asset-box{ display:flex; align-items:center; gap:8px; }
  .asset-box img{ width:24px; height:24px; border-radius:50%; }
  .asset-box .asset-name{ font-weight:600; }
  .asset-box .asset-issuer{ font-size:.8rem; color:var(--muted); }
  .swap-icon{ font-size:1.5rem; background:#fff; border-radius:50%; padding:5px; border:1px solid var(--line); cursor:pointer; transition:all 0.3s ease; }
  .swap-icon:hover{ background:var(--brand); color:#fff; transform:rotate(180deg); }
  
  /* Enhanced Trade Tabs */
  .trade-tabs{ display:flex; border-bottom:1px solid var(--line); background:#f8f9fa; }
  .trade-tabs .tab{ 
    flex:1; padding:12px; text-align:center; cursor:pointer; font-weight:600; 
    color:var(--muted); border-bottom:3px solid transparent; 
    transition:all 0.3s ease; position:relative;
  }
  .trade-tabs .tab:hover{ background:rgba(0,82,204,0.1); color:var(--brand); }
  .trade-tabs .tab.active{ color:var(--brand); border-bottom-color:var(--brand); background:#fff; }
  
  /* Tab Content Areas */
  .tab-content{ display:none; }
  .tab-content.active{ display:block; }
  
  /* Overview Content */
  .overview-content{ padding:20px; text-align:center; }
  .price-display{ font-size:2.5rem; font-weight:bold; margin-bottom:10px; color:var(--brand); }
  .price-change{ font-size:1rem; margin-bottom:20px; }
  .price-change.positive{ color:var(--ok); }
  .price-change.negative{ color:var(--err); }
  .chart-timeframes{ display:flex; justify-content:center; gap:10px; margin-bottom:20px; }
  .timeframe-btn{ 
    padding:8px 15px; border-radius:8px; border:1px solid var(--line); 
    background:#f8f9fa; color:var(--text); cursor:pointer; transition:all 0.3s ease;
    font-size:0.9rem; font-weight:600;
  }
  .timeframe-btn:hover, .timeframe-btn.active{ background:var(--brand); color:#fff; border-color:var(--brand); }
  .chart-placeholder{ 
    width:100%; height:200px; background:#f0f0f0; border-radius:12px; 
    display:flex; align-items:center; justify-content:center; color:var(--muted);
    border:2px dashed #ddd; margin-bottom:20px;
  }
  .market-stats{ display:grid; grid-template-columns:1fr 1fr; gap:15px; text-align:left; }
  .stat-item{ background:#f8f9fa; padding:12px; border-radius:8px; border:1px solid var(--line); }
  .stat-label{ font-size:0.8rem; color:var(--muted); margin-bottom:4px; }
  .stat-value{ font-weight:600; color:var(--text); }
  
  /* Orderbook Content */
  .orderbook-content{ padding:10px 20px 20px; }
  .orderbook-table{ width:100%; border-collapse:collapse; margin-bottom:10px; }
  .orderbook-table th,.orderbook-table td{ text-align:right; padding:8px 4px; font-size:.9rem; }
  .orderbook-table th{ color:var(--muted); font-weight:600; border-bottom:2px solid var(--line); }
  .orderbook-table th:first-child,.orderbook-table td:first-child{ text-align:left; }
  .orderbook-table .bid-row{ cursor:pointer; transition:background 0.2s ease; }
  .orderbook-table .bid-row:hover{ background:rgba(40,167,69,0.1); }
  .orderbook-table .bid-row td:nth-child(2){ color:var(--ok); font-weight:600; }
  .orderbook-table .ask-row{ cursor:pointer; transition:background 0.2s ease; }
  .orderbook-table .ask-row:hover{ background:rgba(220,53,69,0.1); }
  .orderbook-table .ask-row td:nth-child(2){ color:var(--err); font-weight:600; }
  .spread{ 
    padding:12px 0; text-align:center; font-weight:bold; 
    border-top:1px solid var(--line); border-bottom:1px solid var(--line); 
    margin:8px 0; background:#f8f9fa; border-radius:8px;
  }
  .loading-spinner{ 
    display:inline-block; width:20px; height:20px; 
    border:3px solid #f3f3f3; border-top:3px solid var(--brand); 
    border-radius:50%; animation:spin 1s linear infinite; 
  }
  @keyframes spin{ 0%{ transform:rotate(0deg); } 100%{ transform:rotate(360deg); } }
  
  /* Last Trades Content */
  .trades-content{ padding:10px 20px 20px; }
  .trades-table{ width:100%; border-collapse:collapse; }
  .trades-table th,.trades-table td{ text-align:right; padding:8px 4px; font-size:.9rem; }
  .trades-table th{ color:var(--muted); font-weight:600; border-bottom:2px solid var(--line); }
  .trades-table th:first-child,.trades-table td:first-child{ text-align:left; }
  .trade-buy{ color:var(--ok); }
  .trade-sell{ color:var(--err); }
  .trade-time{ color:var(--muted); font-size:0.8rem; }
  
  /* Enhanced Trade Actions */
  .trade-actions{ display:flex; gap:15px; padding:20px; background:#f8f9fa; border-top:1px solid var(--line); }
  .trade-actions button{ 
    flex:1; padding:16px; font-size:1.1rem; border-radius:12px; text-transform:uppercase; 
    font-weight:700; transition:all 0.3s ease; position:relative; overflow:hidden;
  }
  .trade-actions button:before{
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition:left 0.5s; z-index:1;
  }
  .trade-actions button:hover:before{ left:100%; }
  .btn-buy{ background:var(--ok); box-shadow:0 4px 14px rgba(40,167,69,0.3); }
  .btn-buy:hover{ background:#218838; box-shadow:0 6px 20px rgba(40,167,69,0.4); transform:translateY(-2px); }
  .btn-sell{ background:var(--err); color:#fff; box-shadow:0 4px 14px rgba(220,53,69,0.3); }
  .btn-sell:hover{ background:#c82333; box-shadow:0 6px 20px rgba(220,53,69,0.4); transform:translateY(-2px); }

  /* Enhanced Modal */
  .trade-modal{ display:none; position:fixed; inset:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
  .trade-modal.show{ display:flex; }
  .modal-content{ 
    background:var(--card); border:1px solid var(--line); border-radius:var(--rad); 
    box-shadow:0 20px 40px rgba(0,0,0,0.15); padding:20px; max-width:420px; width:90%; 
    max-height:90vh; overflow-y:auto; animation:modalSlideIn 0.3s ease-out;
  }
  @keyframes modalSlideIn{ from{ opacity:0; transform:translateY(-50px); } to{ opacity:1; transform:translateY(0); } }
  .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .modal-title{ font-size:1.5rem; font-weight:700; color:var(--brand); margin:0; }
  .modal-close{ 
    background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--muted); 
    padding:5px; width:auto; height:auto; box-shadow:none; text-transform:none; 
    border-radius:50%; transition:all 0.3s ease;
  }
  .modal-close:hover{ color:var(--text); background:rgba(0,0,0,0.1); transform:none; box-shadow:none; }
  .panel{ background:#f8f9fa; border:1px solid var(--line); border-radius:12px; padding:20px; margin:0; }
  .titleRow{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .title{ font-size:1.2rem; font-weight:700; color:var(--brand); }
  .avail{ font-size:.9rem; color:var(--muted); }
  .field{ margin-bottom:16px; }
  .inputWrap{ position:relative; display:flex; align-items:center; }
  .inputWrap input{ padding-right:60px; margin:0; border:2px solid var(--line); transition:border-color 0.3s ease; }
  .inputWrap input:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(0,82,204,0.1); }
  .unit{ position:absolute; right:12px; color:var(--muted); font-weight:600; pointer-events:none; }
  .hint{ font-size:.8rem; color:var(--muted); margin-top:4px; text-align:left; }
  .rowBtns{ display:flex; gap:8px; margin-top:8px; }
  .rowBtns button{ 
    flex:1; padding:8px 12px; font-size:.9rem; background:#e9ecef; color:var(--text); 
    border:1px solid var(--line); text-transform:none; font-weight:600; border-radius:6px;
    transition:all 0.3s ease;
  }
  .rowBtns button:hover{ background:var(--brand); color:#fff; transform:translateY(-1px); }
  .totalBox{ margin-bottom:20px; }
  .totalBox input{ background:#e9ecef; color:var(--muted); }
  .cta{ 
    padding:16px; font-size:1.1rem; font-weight:700; text-transform:uppercase; margin:0; 
    border-radius:12px; transition:all 0.3s ease; position:relative; overflow:hidden;
  }
  .cta:before{
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition:left 0.5s; z-index:1;
  }
  .cta:hover:before{ left:100%; }
  .cta.buy{ background:var(--ok); box-shadow:0 4px 14px rgba(40,167,69,0.3); }
  .cta.buy:hover{ background:#218838; box-shadow:0 6px 20px rgba(40,167,69,0.4); transform:translateY(-2px); }
  .cta.sell{ background:var(--err); color:#fff; box-shadow:0 4px 14px rgba(220,53,69,0.3); }
  .cta.sell:hover{ background:#c82333; box-shadow:0 6px 20px rgba(220,53,69,0.4); transform:translateY(-2px); }

  /* Animation */
  .import-card {
    animation: slideUp 0.6s ease-out;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 480px) {
    .app {
      max-width: 100%;
      padding: 0 10px;
    }
    
    .import-card {
      padding: 30px 20px;
      margin: 10px;
    }
    
    .logo-container img {
      width: 60px;
      height: 60px;
    }
    
    h1 {
      font-size: 2.2rem;
    }

    .key-modal-content {
      padding: 30px 20px;
      margin: 10px;
    }

    .key-display-input {
      font-size: 12px;
      padding: 12px 50px 12px 12px;
    }

    .copy-btn {
      padding: 6px 8px;
      font-size: 10px;
    }

    .market-stats {
      grid-template-columns: 1fr;
    }

    .chart-timeframes {
      flex-wrap: wrap;
    }
  }
</style>
</head>
<body>
  <div class="app">
    <div class="logo-container">
      <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam Logo">
      <h1>Laam wallet</h1>
    </div>

    <!-- AUTH SECTION - Modified to match the image design exactly -->
    <div id="authSection">
      <div class="import-card">
        <div id="unlockView" class="hidden">
          <h3 style="margin:0 0 20px 0; color:#1976d2; text-align:center; font-size:1.5rem;">Unlock Wallet</h3>
          <div class="form-group">
            <label class="form-label" for="walletPassword">Password</label>
            <input class="form-input" id="walletPassword" type="password" placeholder="Enter your password" />
          </div>
          <button class="import-button" id="unlockBtn">Unlock</button>
          <div class="divider">
            <span class="divider-text">or</span>
          </div>
          <div class="generate-link">
            <a href="#" id="resetWalletLink" style="color:#1976d2; text-decoration:none;">Reset and Import New Key</a>
          </div>
        </div>

        <div id="initialView">
          <!-- Single card design exactly matching the image -->
          <div class="form-group">
            <label class="form-label" for="secretKeyInput">Secret Key (S...)</label>
            <input class="form-input" id="secretKeyInput" type="password" placeholder="SXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"/>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="savePasswordInput">Create Password to Save</label>
            <input class="form-input" id="savePasswordInput" type="password" placeholder="Min 8 chars"/>
          </div>
          
          <button class="import-button" id="importAndSaveBtn">Import wallet and Save</button>
          
          <div class="divider">
            <span class="divider-text">or</span>
          </div>
          
          <div class="generate-link">
            <button class="generate-button" id="generateAccountBtn">Create new wallet</button>
            <p class="note-text">(xasuuso: waa in aad ku shubtaa wallet kaaga ugu yaraan 4 XLM si uu ufurmo)</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Key Display Modal -->
    <div id="keyModal" class="key-modal">
      <div class="key-modal-content">
        <div class="key-modal-header">
          <h3 class="key-modal-title">New Wallet Account Generated</h3>
          <button class="key-modal-close" onclick="closeKeyModal()">&times;</button>
        </div>
        
        <div class="key-display-group">
          <label class="key-display-label">Secret Key (S...)</label>
          <div class="key-display-container">
            <textarea class="key-display-input" id="generatedSecretKey" readonly rows="3"></textarea>
            <button class="copy-btn" onclick="copyToClipboard('generatedSecretKey', this)">Copy</button>
          </div>
        </div>

        <div class="key-display-group">
          <label class="key-display-label">Public Key (G...)</label>
          <div class="key-display-container">
            <textarea class="key-display-input" id="generatedPublicKey" readonly rows="2"></textarea>
            <button class="copy-btn" onclick="copyToClipboard('generatedPublicKey', this)">Copy</button>
          </div>
        </div>

        <div class="warning-text">
          <strong>‚ö†Ô∏è MUHIIM:</strong> Ku kaydi Secret Key-ga meel ammaan ah! Waad ubaahan doontaa si aad u gasho wallet-kaaga. Haddii aad lumiso, ma heli kartid account-kaaga. Sidoo kale copy dheh public key kaaga oo kushub ugu yaraan 4 XLM si uu wallet kaagu kuugu furmo.
        </div>

        <button class="use-account-btn" onclick="useGeneratedAccount()">Use This Account</button>
      </div>
    </div>

    <!-- LOGGED IN VIEW - Keep all original functionality -->
    <div id="loggedInView" class="hidden">
      <div class="card">
        <div class="balances">
          <div class="pill">
            <div>XLM: <span id="xlmBal">0.00</span></div>
            <div class="muted" style="font-size:0.8rem;">$<span id="xlmUsd">0.00</span> ($<span id="xlmPrice">0.00</span>/XLM)</div>
          </div>
          <div class="pill">
            <div>Laam: <span id="laamBal">0.00</span></div>
            <div class="muted" style="font-size:0.8rem;">$<span id="laamUsd">0.00</span> ($<span id="laamPrice">0.06</span>/Laam)</div>
          </div>
        </div>
        <label style="margin-top:10px;">Your Public Key</label>
        <div id="pubKey" class="mono">-</div>
        <div style="display:flex; gap:10px; margin-top:16px; justify-content:center;">
          <button id="btnSendToggle">Send</button>
          <button id="addTrustlineBtn">Add Laam Trustline</button>
          <button id="logoutBtn" class="btn-danger">Lock Wallet</button>
        </div>

        <div id="sendForm" class="send-wrap">
          <h4 style="margin:0 0 10px 0; color:var(--brand)">Send Assets</h4>
          <div class="send-row">
            <div><label for="sendAsset">Asset</label><select id="sendAsset"><option value="XLM">XLM</option><option value="LAAM">Laam</option></select></div>
            <div><label for="sendAmount">Amount</label><input id="sendAmount" type="number" step="0.0000001" placeholder="e.g. 10" /></div>
          </div>
          <label for="sendDest" style="margin-top:8px;">Destination Public Key</label>
          <input id="sendDest" type="text" placeholder="G... destination" />
          <button id="btnSend" style="margin-top:10px;">Send Now</button>
        </div>
      </div>

      <!-- Enhanced Trade Section -->
      <div class="card trade-card">
        <div class="trade-header">
          <span class="icon">‚Üê</span>
          <h3>Trade</h3>
          <span class="icon" id="refreshOB">‚Üª</span>
        </div>
        <div class="trade-asset-selector">
          <div class="asset-box">
            <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam">
            <div>
              <div class="asset-name">Laam</div>
              <div class="asset-issuer">laam.online</div>
            </div>
          </div>
          <span class="swap-icon" id="swapAssets">‚áÑ</span>
          <div class="asset-box">
            <img src="https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png" alt="XLM">
            <div>
              <div class="asset-name">XLM</div>
              <div class="asset-issuer">stellar.org</div>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Trade Tabs -->
        <div class="trade-tabs">
          <div class="tab" id="overviewTab">Overview</div>
          <div class="tab active" id="orderbookTab">Orderbook</div>
          <div class="tab" id="lastTradesTab">Last Trades</div>
        </div>
        
        <!-- Overview Tab Content -->
        <div id="overviewContent" class="tab-content">
          <div class="overview-content">
            <div class="price-display">
              <span id="overviewLaamPriceXLM">0.135000</span> XLM
            </div>
            <div class="price-change positive" id="priceChange">+0.005000 (+3.85%)</div>
            
            <div class="chart-timeframes">
              <button class="timeframe-btn active" data-timeframe="1D">1D</button>
              <button class="timeframe-btn" data-timeframe="1W">1W</button>
              <button class="timeframe-btn" data-timeframe="1M">1M</button>
              <button class="timeframe-btn" data-timeframe="1Y">1Y</button>
            </div>
            
            <div class="chart-placeholder">
              üìà Price Chart (Coming Soon)
            </div>
            
            <div class="market-stats">
              <div class="stat-item">
                <div class="stat-label">24h Volume</div>
                <div class="stat-value">12,450 Laam</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">24h High</div>
                <div class="stat-value">0.142000 XLM</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">24h Low</div>
                <div class="stat-value">0.128000 XLM</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Market Cap</div>
                <div class="stat-value">180,253 XLM</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Orderbook Tab Content -->
        <div id="orderbookContent" class="tab-content active">
          <div class="orderbook-content">
            <table class="orderbook-table">
              <thead><tr><th>Amount (Laam)</th><th>Price (XLM)</th><th>Total (XLM)</th></tr></thead>
              <tbody id="asksBody">
                <tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
            <div class="spread" id="spreadValue">Loading spread...</div>
            <table class="orderbook-table">
              <tbody id="bidsBody">
                <tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Last Trades Tab Content -->
        <div id="lastTradesContent" class="tab-content">
          <div class="trades-content">
            <table class="trades-table">
              <thead><tr><th>Time</th><th>Type</th><th>Price (XLM)</th><th>Amount (Laam)</th></tr></thead>
              <tbody id="tradesBody">
                <tr><td colspan="4" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="trade-actions">
          <button class="btn-buy" id="btnBuy">Buy</button>
          <button class="btn-sell" id="btnSell">Sell</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Trade Modal -->
  <div id="tradeModal" class="trade-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Buy Laam</h3>
        <button class="modal-close" onclick="closeTradeModal()">&times;</button>
      </div>
      <div class="panel">
        <div class="titleRow">
          <div class="title" id="panelTitle">Buy Laam</div>
          <div class="avail">Available: <span id="availBalance">0 XLM</span></div>
        </div>

        <div class="field">
          <div class="inputWrap">
            <input id="modalPrice" type="number" step="0.0000001" placeholder="0.135000" />
            <div class="unit">XLM</div>
          </div>
          <div class="hint">Price (XLM per Laam)</div>
        </div>

        <div class="field">
          <div class="inputWrap">
            <input id="modalAmount" type="number" step="0.0000001" placeholder="Amount" />
            <div class="unit">Laam</div>
          </div>
          <div class="rowBtns">
            <button data-fill="25">25%</button>
            <button data-fill="50">50%</button>
            <button data-fill="75">75%</button>
            <button data-fill="100">100%</button>
          </div>
        </div>

        <div class="totalBox">
          <div class="inputWrap">
            <input id="modalTotal" type="number" step="0.0000001" placeholder="Total" readonly />
            <div class="unit">XLM</div>
          </div>
          <div class="hint">Total cost</div>
        </div>

        <button class="cta buy" id="modalBuyBtn">Buy Laam</button>
      </div>
    </div>
  </div>

  <script>
    // Laam token configuration - CORRECTED
    const LAAM_TOKEN = {
      code: "Laam",
      issuer: "GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64",
      name: "Laam",
      description: "Laam is a limited supply token on Stellar with a maximum of 1,335,577 tokens, issued only once to preserve value.",
      image: "https://i.ibb.co/r28SP1bN/20250802-225108.png",
      maxSupply: 1335577,
      currentPrice: 0.06
    };

    // Global variables
    let currentKeypair = null;
    let server = null;
    let isTestnet = false;
    let LAAM_ASSET = null;
    let xlmPriceUSD = 0.12; // Default XLM price in USD
    let currentTradeMode = 'buy'; // 'buy' or 'sell'
    let generatedKeypair = null; // Store generated keypair
    let currentTab = 'orderbook'; // Current active tab
    let orderbookData = { bids: [], asks: [] };
    let tradesData = [];
    
    // Initialize Stellar SDK when page loads
    function initializeStellar() {
      try {
        if (typeof StellarSdk !== 'undefined') {
          server = new StellarSdk.Server('https://horizon.stellar.org');
          console.log('Stellar SDK initialized successfully');
        } else {
          console.error('Stellar SDK not loaded');
          showError('Stellar SDK failed to load. Please refresh the page.');
        }
      } catch (error) {
        console.error('Error initializing Stellar SDK:', error);
        showError('Failed to initialize Stellar SDK: ' + error.message);
      }
    }
    
    function initializeAssets() {
      try {
        if (typeof StellarSdk !== 'undefined') {
          LAAM_ASSET = new StellarSdk.Asset(LAAM_TOKEN.code, LAAM_TOKEN.issuer);
          console.log('Assets initialized successfully');
        }
      } catch (error) {
        console.error('Error initializing assets:', error);
      }
    }
    
    // Utility functions
    function showError(message) {
      alert('Error: ' + message);
    }
    
    function showSuccess(message) {
      alert('Success: ' + message);
    }
    
    function formatAmount(amount) {
      return parseFloat(amount).toFixed(7);
    }
    
    function encryptSecretKey(secretKey, password) {
      return CryptoJS.AES.encrypt(secretKey, password).toString();
    }
    
    function decryptSecretKey(encryptedKey, password) {
      try {
        const bytes = CryptoJS.AES.decrypt(encryptedKey, password);
        return bytes.toString(CryptoJS.enc.Utf8);
      } catch (e) {
        return null;
      }
    }

    // Copy to clipboard function
    async function copyToClipboard(elementId, buttonElement) {
      try {
        const element = document.getElementById(elementId);
        const text = element.value;
        
        await navigator.clipboard.writeText(text);
        
        // Visual feedback
        const originalText = buttonElement.textContent;
        buttonElement.textContent = 'Copied!';
        buttonElement.classList.add('copied');
        
        setTimeout(() => {
          buttonElement.textContent = originalText;
          buttonElement.classList.remove('copied');
        }, 2000);
        
      } catch (err) {
        console.error('Failed to copy:', err);
        // Fallback for older browsers
        const element = document.getElementById(elementId);
        element.select();
        element.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        const originalText = buttonElement.textContent;
        buttonElement.textContent = 'Copied!';
        buttonElement.classList.add('copied');
        
        setTimeout(() => {
          buttonElement.textContent = originalText;
          buttonElement.classList.remove('copied');
        }, 2000);
      }
    }

    // Key modal functions
    function openKeyModal(secretKey, publicKey) {
      document.getElementById('generatedSecretKey').value = secretKey;
      document.getElementById('generatedPublicKey').value = publicKey;
      document.getElementById('keyModal').classList.add('show');
    }

    function closeKeyModal() {
      document.getElementById('keyModal').classList.remove('show');
      generatedKeypair = null;
    }

    function useGeneratedAccount() {
      if (generatedKeypair) {
        document.getElementById('secretKeyInput').value = generatedKeypair.secret();
        closeKeyModal();
        showSuccess('Account keys have been filled in the form. Please create a password to save your wallet.');
      }
    }

    // Tab switching functionality
    function switchTab(tabName) {
      // Remove active class from all tabs and contents
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Add active class to selected tab and content
      document.getElementById(tabName + 'Tab').classList.add('active');
      document.getElementById(tabName + 'Content').classList.add('active');
      
      currentTab = tabName;
      
      // Load data for the selected tab
      if (tabName === 'orderbook') {
        fetchOrderbook();
      } else if (tabName === 'lastTrades') {
        fetchTrades();
      } else if (tabName === 'overview') {
        updateOverview();
      }
    }

    // Fetch XLM price from API
    async function fetchXLMPrice() {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=stellar&vs_currencies=usd');
        const data = await response.json();
        if (data.stellar && data.stellar.usd) {
          xlmPriceUSD = data.stellar.usd;
          console.log('XLM price updated:', xlmPriceUSD);
        }
      } catch (error) {
        console.error('Error fetching XLM price:', error);
        // Use default price if API fails
        xlmPriceUSD = 0.12;
      }
    }

    // Update overview tab
    function updateOverview() {
      // Update price display with sample data
      const currentPrice = 0.135000;
      const priceChange = 0.005000;
      const priceChangePercent = ((priceChange / (currentPrice - priceChange)) * 100).toFixed(2);
      
      document.getElementById('overviewLaamPriceXLM').textContent = currentPrice.toFixed(6);
      
      const priceChangeElement = document.getElementById('priceChange');
      priceChangeElement.textContent = `+${priceChange.toFixed(6)} (+${priceChangePercent}%)`;
      priceChangeElement.className = priceChange >= 0 ? 'price-change positive' : 'price-change negative';
    }

    // Fetch orderbook data
    async function fetchOrderbook() {
      try {
        console.log('Fetching orderbook data...');
        
        // Show loading state
        document.getElementById('asksBody').innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading asks...</td></tr>';
        document.getElementById('bidsBody').innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading bids...</td></tr>';
        document.getElementById('spreadValue').innerHTML = '<div class="loading-spinner"></div> Loading spread...';
        
        // Fetch orderbook from Stellar Horizon API
        const orderbookUrl = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=${LAAM_TOKEN.code}&selling_asset_issuer=${LAAM_TOKEN.issuer}&buying_asset_type=native&limit=10`;
        
        const response = await fetch(orderbookUrl);
        const data = await response.json();
        
        console.log('Orderbook data received:', data);
        
        // Clear existing data
        document.getElementById('asksBody').innerHTML = '';
        document.getElementById('bidsBody').innerHTML = '';
        
        // Display asks (sell orders)
        const asksBody = document.getElementById('asksBody');
        if (data.asks && data.asks.length > 0) {
          orderbookData.asks = data.asks;
          data.asks.slice(0, 5).forEach(ask => {
            const row = document.createElement('tr');
            row.className = 'ask-row';
            const amount = parseFloat(ask.amount).toFixed(2);
            const price = parseFloat(ask.price).toFixed(7);
            const total = (parseFloat(ask.amount) * parseFloat(ask.price)).toFixed(7);
            
            row.innerHTML = `
              <td>${amount}</td>
              <td>${price}</td>
              <td>${total}</td>
            `;
            
            // Add click handler to fill price in modal
            row.addEventListener('click', () => {
              if (document.getElementById('tradeModal').classList.contains('show')) {
                document.getElementById('modalPrice').value = price;
                calculateTotal();
              }
            });
            
            asksBody.appendChild(row);
          });
        } else {
          // Show sample data if no real orders
          const sampleAsks = [
            { amount: '1000.00', price: '0.1450000', total: '145.0000000' },
            { amount: '750.00', price: '0.1400000', total: '105.0000000' },
            { amount: '500.00', price: '0.1380000', total: '69.0000000' },
            { amount: '1200.00', price: '0.1360000', total: '163.2000000' },
            { amount: '800.00', price: '0.1350000', total: '108.0000000' }
          ];
          
          sampleAsks.forEach(ask => {
            const row = document.createElement('tr');
            row.className = 'ask-row';
            row.innerHTML = `
              <td>${ask.amount}</td>
              <td>${ask.price}</td>
              <td>${ask.total}</td>
            `;
            
            // Add click handler
            row.addEventListener('click', () => {
              if (document.getElementById('tradeModal').classList.contains('show')) {
                document.getElementById('modalPrice').value = ask.price;
                calculateTotal();
              }
            });
            
            asksBody.appendChild(row);
          });
        }
        
        // Display bids (buy orders)
        const bidsBody = document.getElementById('bidsBody');
        if (data.bids && data.bids.length > 0) {
          orderbookData.bids = data.bids;
          data.bids.slice(0, 5).forEach(bid => {
            const row = document.createElement('tr');
            row.className = 'bid-row';
            const amount = parseFloat(bid.amount).toFixed(2);
            const price = parseFloat(bid.price).toFixed(7);
            const total = (parseFloat(bid.amount) * parseFloat(bid.price)).toFixed(7);
            
            row.innerHTML = `
              <td>${amount}</td>
              <td>${price}</td>
              <td>${total}</td>
            `;
            
            // Add click handler to fill price in modal
            row.addEventListener('click', () => {
              if (document.getElementById('tradeModal').classList.contains('show')) {
                document.getElementById('modalPrice').value = price;
                calculateTotal();
              }
            });
            
            bidsBody.appendChild(row);
          });
        } else {
          // Show sample data if no real orders
          const sampleBids = [
            { amount: '900.00', price: '0.1300000', total: '117.0000000' },
            { amount: '1100.00', price: '0.1280000', total: '140.8000000' },
            { amount: '600.00', price: '0.1250000', total: '75.0000000' },
            { amount: '1500.00', price: '0.1220000', total: '183.0000000' },
            { amount: '700.00', price: '0.1200000', total: '84.0000000' }
          ];
          
          sampleBids.forEach(bid => {
            const row = document.createElement('tr');
            row.className = 'bid-row';
            row.innerHTML = `
              <td>${bid.amount}</td>
              <td>${bid.price}</td>
              <td>${bid.total}</td>
            `;
            
            // Add click handler
            row.addEventListener('click', () => {
              if (document.getElementById('tradeModal').classList.contains('show')) {
                document.getElementById('modalPrice').value = bid.price;
                calculateTotal();
              }
            });
            
            bidsBody.appendChild(row);
          });
        }
        
        // Calculate and display spread
        let spread = 'No data';
        if (data.asks && data.asks.length > 0 && data.bids && data.bids.length > 0) {
          const bestAsk = parseFloat(data.asks[0].price);
          const bestBid = parseFloat(data.bids[0].price);
          const spreadValue = bestAsk - bestBid;
          const spreadPercent = ((spreadValue / bestBid) * 100).toFixed(2);
          spread = `Spread: ${spreadValue.toFixed(7)} XLM (${spreadPercent}%)`;
        } else {
          spread = 'Spread: 0.0150000 XLM (11.54%)'; // Sample spread
        }
        
        document.getElementById('spreadValue').textContent = spread;
        
        console.log('Orderbook updated successfully');
        
      } catch (error) {
        console.error('Error fetching orderbook:', error);
        
        // Show sample data on error
        document.getElementById('asksBody').innerHTML = `
          <tr class="ask-row"><td>1000.00</td><td>0.1450000</td><td>145.0000000</td></tr>
          <tr class="ask-row"><td>750.00</td><td>0.1400000</td><td>105.0000000</td></tr>
          <tr class="ask-row"><td>500.00</td><td>0.1380000</td><td>69.0000000</td></tr>
          <tr class="ask-row"><td>1200.00</td><td>0.1360000</td><td>163.2000000</td></tr>
          <tr class="ask-row"><td>800.00</td><td>0.1350000</td><td>108.0000000</td></tr>
        `;
        
        document.getElementById('bidsBody').innerHTML = `
          <tr class="bid-row"><td>900.00</td><td>0.1300000</td><td>117.0000000</td></tr>
          <tr class="bid-row"><td>1100.00</td><td>0.1280000</td><td>140.8000000</td></tr>
          <tr class="bid-row"><td>600.00</td><td>0.1250000</td><td>75.0000000</td></tr>
          <tr class="bid-row"><td>1500.00</td><td>0.1220000</td><td>183.0000000</td></tr>
          <tr class="bid-row"><td>700.00</td><td>0.1200000</td><td>84.0000000</td></tr>
        `;
        
        document.getElementById('spreadValue').textContent = 'Spread: 0.0150000 XLM (11.54%)';
        
        // Add click handlers to sample data
        document.querySelectorAll('.ask-row, .bid-row').forEach(row => {
          row.addEventListener('click', () => {
            const price = row.children[1].textContent;
            if (document.getElementById('tradeModal').classList.contains('show')) {
              document.getElementById('modalPrice').value = price;
              calculateTotal();
            }
          });
        });
      }
    }

    // Fetch trades data
    async function fetchTrades() {
      try {
        console.log('Fetching trades data...');
        
        // Show loading state
        document.getElementById('tradesBody').innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading trades...</td></tr>';
        
        // Fetch trades from Stellar Horizon API
        const tradesUrl = `https://horizon.stellar.org/trades?base_asset_type=credit_alphanum4&base_asset_code=${LAAM_TOKEN.code}&base_asset_issuer=${LAAM_TOKEN.issuer}&counter_asset_type=native&limit=20&order=desc`;
        
        const response = await fetch(tradesUrl);
        const data = await response.json();
        
        console.log('Trades data received:', data);
        
        const tradesBody = document.getElementById('tradesBody');
        tradesBody.innerHTML = '';
        
        if (data._embedded && data._embedded.records && data._embedded.records.length > 0) {
          tradesData = data._embedded.records;
          data._embedded.records.slice(0, 10).forEach(trade => {
            const row = document.createElement('tr');
            const time = new Date(trade.ledger_close_time).toLocaleTimeString();
            const type = trade.base_is_seller ? 'SELL' : 'BUY';
            const price = parseFloat(trade.price.n / trade.price.d).toFixed(7);
            const amount = parseFloat(trade.base_amount).toFixed(2);
            
            row.innerHTML = `
              <td class="trade-time">${time}</td>
              <td class="${type.toLowerCase() === 'buy' ? 'trade-buy' : 'trade-sell'}">${type}</td>
              <td>${price}</td>
              <td>${amount}</td>
            `;
            tradesBody.appendChild(row);
          });
        } else {
          // Show sample data if no real trades
          const sampleTrades = [
            { time: '14:32:15', type: 'BUY', price: '0.1350000', amount: '250.00' },
            { time: '14:28:42', type: 'SELL', price: '0.1340000', amount: '180.50' },
            { time: '14:25:18', type: 'BUY', price: '0.1345000', amount: '320.75' },
            { time: '14:22:03', type: 'BUY', price: '0.1338000', amount: '150.25' },
            { time: '14:18:47', type: 'SELL', price: '0.1335000', amount: '400.00' },
            { time: '14:15:22', type: 'BUY', price: '0.1342000', amount: '275.50' },
            { time: '14:12:08', type: 'SELL', price: '0.1330000', amount: '190.75' },
            { time: '14:08:35', type: 'BUY', price: '0.1348000', amount: '225.00' }
          ];
          
          sampleTrades.forEach(trade => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="trade-time">${trade.time}</td>
              <td class="${trade.type.toLowerCase() === 'buy' ? 'trade-buy' : 'trade-sell'}">${trade.type}</td>
              <td>${trade.price}</td>
              <td>${trade.amount}</td>
            `;
            tradesBody.appendChild(row);
          });
        }
        
        console.log('Trades updated successfully');
        
      } catch (error) {
        console.error('Error fetching trades:', error);
        
        // Show sample data on error
        const sampleTrades = [
          { time: '14:32:15', type: 'BUY', price: '0.1350000', amount: '250.00' },
          { time: '14:28:42', type: 'SELL', price: '0.1340000', amount: '180.50' },
          { time: '14:25:18', type: 'BUY', price: '0.1345000', amount: '320.75' },
          { time: '14:22:03', type: 'BUY', price: '0.1338000', amount: '150.25' },
          { time: '14:18:47', type: 'SELL', price: '0.1335000', amount: '400.00' }
        ];
        
        const tradesBody = document.getElementById('tradesBody');
        tradesBody.innerHTML = '';
        
        sampleTrades.forEach(trade => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="trade-time">${trade.time}</td>
            <td class="${trade.type.toLowerCase() === 'buy' ? 'trade-buy' : 'trade-sell'}">${trade.type}</td>
            <td>${trade.price}</td>
            <td>${trade.amount}</td>
          `;
          tradesBody.appendChild(row);
        });
      }
    }

    // Update balance display function
    async function updateBalanceDisplay() {
      if (!currentKeypair || !server) {
        console.log('No keypair or server available');
        return;
      }

      try {
        console.log('Loading account data...');
        const account = await server.loadAccount(currentKeypair.publicKey());
        
        let xlmBalance = 0;
        let laamBalance = 0;

        // Process all balances
        account.balances.forEach(balance => {
          console.log('Processing balance:', balance);
          
          if (balance.asset_type === 'native') {
            xlmBalance = parseFloat(balance.balance);
          } else if (balance.asset_code === LAAM_TOKEN.code && balance.asset_issuer === LAAM_TOKEN.issuer) {
            laamBalance = parseFloat(balance.balance);
            console.log('Found Laam balance:', laamBalance);
          }
        });

        // Update XLM balance with USD values
        document.getElementById('xlmBal').textContent = xlmBalance.toFixed(2);
        document.getElementById('xlmUsd').textContent = (xlmBalance * xlmPriceUSD).toFixed(2);
        document.getElementById('xlmPrice').textContent = xlmPriceUSD.toFixed(3);

        // Update Laam balance
        document.getElementById('laamBal').textContent = laamBalance.toFixed(2);
        document.getElementById('laamUsd').textContent = (laamBalance * LAAM_TOKEN.currentPrice).toFixed(2);
        document.getElementById('laamPrice').textContent = LAAM_TOKEN.currentPrice.toFixed(2);

        console.log('Balance display updated successfully');
        
      } catch (error) {
        console.error('Error updating balance display:', error);
        showError('Failed to load account balance: ' + error.message);
      }
    }

    // Load wallet function
    async function loadWallet() {
      if (!currentKeypair) {
        console.error('No keypair available');
        return;
      }

      try {
        console.log('Loading wallet for:', currentKeypair.publicKey());
        
        // Display public key
        document.getElementById('pubKey').textContent = currentKeypair.publicKey();
        
        // Fetch XLM price first
        await fetchXLMPrice();
        
        // Update balance display
        await updateBalanceDisplay();
        
        // Load initial tab data
        if (currentTab === 'orderbook') {
          await fetchOrderbook();
        } else if (currentTab === 'lastTrades') {
          await fetchTrades();
        } else if (currentTab === 'overview') {
          updateOverview();
        }
        
        console.log('Wallet loaded successfully');
        
      } catch (error) {
        console.error('Error loading wallet:', error);
        showError('Failed to load wallet: ' + error.message);
      }
    }

    // Check if wallet exists in localStorage
    function checkSavedWallet() {
      const encryptedKey = localStorage.getItem('laam_wallet_key');
      if (encryptedKey) {
        document.getElementById('initialView').classList.add('hidden');
        document.getElementById('unlockView').classList.remove('hidden');
      }
    }

    // Trade modal functions
    function openTradeModal(mode) {
      currentTradeMode = mode;
      const modal = document.getElementById('tradeModal');
      const title = document.getElementById('modalTitle');
      const panelTitle = document.getElementById('panelTitle');
      const availBalance = document.getElementById('availBalance');
      const modalBuyBtn = document.getElementById('modalBuyBtn');
      
      if (mode === 'buy') {
        title.textContent = 'Buy Laam';
        panelTitle.textContent = 'Buy Laam';
        modalBuyBtn.textContent = 'Buy Laam';
        modalBuyBtn.className = 'cta buy';
        
        // Get XLM balance for buying
        const xlmBal = document.getElementById('xlmBal').textContent;
        availBalance.textContent = `${xlmBal} XLM`;
      } else {
        title.textContent = 'Sell Laam';
        panelTitle.textContent = 'Sell Laam';
        modalBuyBtn.textContent = 'Sell Laam';
        modalBuyBtn.className = 'cta sell';
        
        // Get Laam balance for selling
        const laamBal = document.getElementById('laamBal').textContent;
        availBalance.textContent = `${laamBal} Laam`;
      }
      
      modal.classList.add('show');
    }

    function closeTradeModal() {
      const modal = document.getElementById('tradeModal');
      modal.classList.remove('show');
      
      // Clear form
      document.getElementById('modalPrice').value = '';
      document.getElementById('modalAmount').value = '';
      document.getElementById('modalTotal').value = '';
    }

    // Calculate total in modal
    function calculateTotal() {
      const price = parseFloat(document.getElementById('modalPrice').value) || 0;
      const amount = parseFloat(document.getElementById('modalAmount').value) || 0;
      const total = price * amount;
      document.getElementById('modalTotal').value = total.toFixed(7);
    }

    // Execute actual trade on Stellar DEX
    async function executeTrade(mode, price, amount) {
      if (!currentKeypair || !LAAM_ASSET) {
        throw new Error('Wallet not loaded or asset not initialized.');
      }

      try {
        const account = await server.loadAccount(currentKeypair.publicKey());
        
        let operation;
        if (mode === 'buy') {
          // Create buy offer: selling XLM, buying Laam
          operation = StellarSdk.Operation.manageBuyOffer({
            selling: StellarSdk.Asset.native(),
            buying: LAAM_ASSET,
            buyAmount: amount.toString(),
            price: price.toString(),
            offerId: '0' // 0 means create new offer
          });
        } else {
          // Create sell offer: selling Laam, buying XLM
          operation = StellarSdk.Operation.manageSellOffer({
            selling: LAAM_ASSET,
            buying: StellarSdk.Asset.native(),
            amount: amount.toString(),
            price: (1/price).toString(), // Invert price for sell offer
            offerId: '0' // 0 means create new offer
          });
        }
        
        const transaction = new StellarSdk.TransactionBuilder(account, {
          fee: StellarSdk.BASE_FEE,
          networkPassphrase: StellarSdk.Networks.PUBLIC
        })
        .addOperation(operation)
        .setTimeout(180)
        .build();
        
        transaction.sign(currentKeypair);
        
        const result = await server.submitTransaction(transaction);
        
        return result;
        
      } catch (error) {
        console.error('Trade execution error:', error);
        throw error;
      }
    }
    
    // Enhanced form validation and interaction
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing...');
      
      // Initialize Stellar SDK and assets
      initializeStellar();
      initializeAssets();
      
      // Check if libraries are loaded
      if (typeof StellarSdk === 'undefined') {
        console.error('StellarSdk is not defined');
        showError('Stellar SDK failed to load. Please refresh the page.');
        return;
      }
      
      if (typeof CryptoJS === 'undefined') {
        console.error('CryptoJS is not defined');
        showError('CryptoJS failed to load. Please refresh the page.');
        return;
      }
      
      console.log('All libraries loaded successfully');
      
      // Check for saved wallet
      checkSavedWallet();
      
      // Form submission handler
      const importForm = document.getElementById('importAndSaveBtn');
      const secretKeyInput = document.getElementById('secretKeyInput');
      const passwordInput = document.getElementById('savePasswordInput');
      
      if (!importForm || !secretKeyInput || !passwordInput) {
        console.error('Required elements not found');
        return;
      }
      
      console.log('Form elements found successfully');
      
      // Add interactive effects
      document.querySelectorAll('.form-input').forEach(input => {
        input.addEventListener('focus', function() {
          this.parentElement.style.transform = 'scale(1.02)';
        });
        
        input.addEventListener('blur', function() {
          this.parentElement.style.transform = 'scale(1)';
        });
      });

      importForm.addEventListener('click', async function(e) {
        e.preventDefault();
        console.log('Import button clicked');
        
        const secretKey = secretKeyInput.value.trim();
        const password = passwordInput.value;
        
        console.log('Secret key length:', secretKey.length);
        console.log('Password length:', password.length);
        
        if (!secretKey.startsWith('S') || secretKey.length !== 56) {
          showError('Invalid secret key format. Secret key should start with S and be 56 characters long.');
          return;
        }
        
        if (password.length < 8) {
          showError('Password must be at least 8 characters long.');
          return;
        }
        
        // Import process
        this.textContent = 'Importing...';
        this.disabled = true;
        
        try {
          console.log('Validating secret key...');
          // Validate secret key
          currentKeypair = StellarSdk.Keypair.fromSecret(secretKey);
          console.log('Secret key validated successfully');
          
          // Encrypt and save
          console.log('Encrypting and saving...');
          const encryptedKey = encryptSecretKey(secretKey, password);
          localStorage.setItem('laam_wallet_key', encryptedKey);
          localStorage.setItem('laam_wallet_public', currentKeypair.publicKey());
          console.log('Wallet saved successfully');
          
          // Load wallet
          console.log('Loading wallet...');
          await loadWallet();
          
          showSuccess('Wallet imported successfully!');
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('loggedInView').classList.remove('hidden');
          
        } catch (error) {
          console.error('Import error:', error);
          showError('Failed to import wallet: ' + error.message);
        } finally {
          this.textContent = 'Import and Save';
          this.disabled = false;
        }
      });
      
      // Generate new account function with modal
      document.getElementById('generateAccountBtn').addEventListener('click', function() {
        console.log('Generate account button clicked');
        
        try {
          generatedKeypair = StellarSdk.Keypair.random();
          const secretKey = generatedKeypair.secret();
          const publicKey = generatedKeypair.publicKey();
          
          console.log('New keypair generated successfully');
          
          // Open modal with keys
          openKeyModal(secretKey, publicKey);
          
        } catch (error) {
          console.error('Generate account error:', error);
          showError('Failed to generate account: ' + error.message);
        }
      });
      
      // Unlock wallet functionality
      document.getElementById('unlockBtn').addEventListener('click', async function() {
        const password = document.getElementById('walletPassword').value;
        const encryptedKey = localStorage.getItem('laam_wallet_key');
        
        if (!encryptedKey) {
          showError('No wallet found. Please import a wallet first.');
          return;
        }
        
        if (!password) {
          showError('Please enter your password.');
          return;
        }
        
        this.textContent = 'Unlocking...';
        this.disabled = true;
        
        try {
          const decryptedKey = decryptSecretKey(encryptedKey, password);
          
          if (!decryptedKey) {
            showError('Incorrect password.');
            return;
          }
          
          currentKeypair = StellarSdk.Keypair.fromSecret(decryptedKey);
          
          await loadWallet();
          
          showSuccess('Wallet unlocked successfully!');
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('loggedInView').classList.remove('hidden');
          
        } catch (error) {
          console.error('Unlock error:', error);
          showError('Failed to unlock wallet: ' + error.message);
        } finally {
          this.textContent = 'Unlock';
          this.disabled = false;
        }
      });
      
      // Reset wallet link
      document.getElementById('resetWalletLink').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (confirm('This will remove your saved wallet. Are you sure?')) {
          localStorage.removeItem('laam_wallet_key');
          localStorage.removeItem('laam_wallet_public');
          
          document.getElementById('unlockView').classList.add('hidden');
          document.getElementById('initialView').classList.remove('hidden');
          
          showSuccess('Wallet reset successfully.');
        }
      });
      
      // Logout functionality
      document.getElementById('logoutBtn').addEventListener('click', function() {
        currentKeypair = null;
        
        document.getElementById('loggedInView').classList.add('hidden');
        document.getElementById('authSection').classList.remove('hidden');
        
        // Show appropriate view
        const encryptedKey = localStorage.getItem('laam_wallet_key');
        if (encryptedKey) {
          document.getElementById('initialView').classList.add('hidden');
          document.getElementById('unlockView').classList.remove('hidden');
        } else {
          document.getElementById('unlockView').classList.add('hidden');
          document.getElementById('initialView').classList.remove('hidden');
        }
      });
      
      // Add Laam trustline functionality
      document.getElementById('addTrustlineBtn').addEventListener('click', async function() {
        if (!currentKeypair || !LAAM_ASSET) {
          showError('Wallet not loaded or asset not initialized.');
          return;
        }
        
        this.textContent = 'Adding Trustline...';
        this.disabled = true;
        
        try {
          const account = await server.loadAccount(currentKeypair.publicKey());
          
          const transaction = new StellarSdk.TransactionBuilder(account, {
            fee: StellarSdk.BASE_FEE,
            networkPassphrase: StellarSdk.Networks.PUBLIC
          })
          .addOperation(StellarSdk.Operation.changeTrust({
            asset: LAAM_ASSET
          }))
          .setTimeout(180)
          .build();
          
          transaction.sign(currentKeypair);
          
          const result = await server.submitTransaction(transaction);
          
          showSuccess('Laam trustline added successfully!');
          
          // Update balance display
          await updateBalanceDisplay();
          
        } catch (error) {
          console.error('Add trustline error:', error);
          showError('Failed to add trustline: ' + error.message);
        } finally {
          this.textContent = 'Add Laam Trustline';
          this.disabled = false;
        }
      });
      
      // Send toggle functionality
      document.getElementById('btnSendToggle').addEventListener('click', function() {
        const sendForm = document.getElementById('sendForm');
        if (sendForm.style.display === 'none' || sendForm.style.display === '') {
          sendForm.style.display = 'block';
        } else {
          sendForm.style.display = 'none';
        }
      });
      
      // Send transaction functionality
      document.getElementById('btnSend').addEventListener('click', async function() {
        const asset = document.getElementById('sendAsset').value;
        const amount = document.getElementById('sendAmount').value;
        const destination = document.getElementById('sendDest').value;
        
        if (!amount || !destination) {
          showError('Please fill in all fields.');
          return;
        }
        
        if (!currentKeypair) {
          showError('Wallet not loaded.');
          return;
        }
        
        this.textContent = 'Sending...';
        this.disabled = true;
        
        try {
          const account = await server.loadAccount(currentKeypair.publicKey());
          
          let operation;
          if (asset === 'XLM') {
            operation = StellarSdk.Operation.payment({
              destination: destination,
              asset: StellarSdk.Asset.native(),
              amount: amount
            });
          } else if (asset === 'LAAM') {
            operation = StellarSdk.Operation.payment({
              destination: destination,
              asset: LAAM_ASSET,
              amount: amount
            });
          }
          
          const transaction = new StellarSdk.TransactionBuilder(account, {
            fee: StellarSdk.BASE_FEE,
            networkPassphrase: StellarSdk.Networks.PUBLIC
          })
          .addOperation(operation)
          .setTimeout(180)
          .build();
          
          transaction.sign(currentKeypair);
          
          const result = await server.submitTransaction(transaction);
          
          showSuccess('Transaction sent successfully!');
          
          // Clear form and hide it
          document.getElementById('sendAmount').value = '';
          document.getElementById('sendDest').value = '';
          document.getElementById('sendForm').style.display = 'none';
          
          // Update balance display
          await updateBalanceDisplay();
          
        } catch (error) {
          console.error('Send transaction error:', error);
          showError('Failed to send transaction: ' + error.message);
        } finally {
          this.textContent = 'Send Now';
          this.disabled = false;
        }
      });

      // Tab switching event listeners
      document.getElementById('overviewTab').addEventListener('click', () => switchTab('overview'));
      document.getElementById('orderbookTab').addEventListener('click', () => switchTab('orderbook'));
      document.getElementById('lastTradesTab').addEventListener('click', () => switchTab('lastTrades'));

      // Timeframe buttons
      document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          // Here you would update the chart for the selected timeframe
        });
      });

      // Trade button functionality
      document.getElementById('btnBuy').addEventListener('click', function() {
        console.log('Buy button clicked');
        openTradeModal('buy');
      });

      document.getElementById('btnSell').addEventListener('click', function() {
        console.log('Sell button clicked');
        openTradeModal('sell');
      });

      // Refresh orderbook button
      document.getElementById('refreshOB').addEventListener('click', function() {
        console.log('Refresh orderbook clicked');
        if (currentTab === 'orderbook') {
          fetchOrderbook();
        } else if (currentTab === 'lastTrades') {
          fetchTrades();
        } else if (currentTab === 'overview') {
          updateOverview();
        }
      });

      // Modal price/amount calculation
      document.getElementById('modalPrice').addEventListener('input', calculateTotal);
      document.getElementById('modalAmount').addEventListener('input', calculateTotal);

      // Percentage buttons in modal
      document.querySelectorAll('.rowBtns button').forEach(btn => {
        btn.addEventListener('click', function() {
          const percentage = parseInt(this.getAttribute('data-fill'));
          const availText = document.getElementById('availBalance').textContent;
          const availAmount = parseFloat(availText.split(' ')[0]);
          const price = parseFloat(document.getElementById('modalPrice').value) || 0;
          
          if (currentTradeMode === 'buy' && price > 0) {
            // For buying: calculate how much Laam we can buy with percentage of XLM
            const xlmToSpend = (availAmount * percentage) / 100;
            const laamAmount = xlmToSpend / price;
            document.getElementById('modalAmount').value = laamAmount.toFixed(7);
          } else if (currentTradeMode === 'sell') {
            // For selling: use percentage of Laam balance
            const laamToSell = (availAmount * percentage) / 100;
            document.getElementById('modalAmount').value = laamToSell.toFixed(7);
          }
          
          calculateTotal();
        });
      });

      // Modal execute trade button with real trading
      document.getElementById('modalBuyBtn').addEventListener('click', async function() {
        const price = parseFloat(document.getElementById('modalPrice').value);
        const amount = parseFloat(document.getElementById('modalAmount').value);
        
        if (!price || !amount) {
          showError('Please enter both price and amount.');
          return;
        }
        
        if (!currentKeypair) {
          showError('Wallet not loaded.');
          return;
        }
        
        // Validate amounts
        const availText = document.getElementById('availBalance').textContent;
        const availAmount = parseFloat(availText.split(' ')[0]);
        
        if (currentTradeMode === 'buy') {
          const totalCost = price * amount;
          if (totalCost > availAmount) {
            showError('Insufficient XLM balance for this trade.');
            return;
          }
        } else {
          if (amount > availAmount) {
            showError('Insufficient Laam balance for this trade.');
            return;
          }
        }
        
        this.disabled = true;
        this.textContent = currentTradeMode === 'buy' ? 'Placing Buy Order...' : 'Placing Sell Order...';
        
        try {
          // Execute real trade on Stellar DEX
          const result = await executeTrade(currentTradeMode, price, amount);
          
          showSuccess(`${currentTradeMode === 'buy' ? 'Buy' : 'Sell'} order placed successfully!\n\nTransaction Hash: ${result.hash}\n\nAmount: ${amount} Laam\nPrice: ${price} XLM per Laam\nTotal: ${(price * amount).toFixed(7)} XLM`);
          
          closeTradeModal();
          
          // Update balance and orderbook
          await updateBalanceDisplay();
          if (currentTab === 'orderbook') {
            await fetchOrderbook();
          }
          
        } catch (error) {
          console.error('Trade error:', error);
          showError('Failed to execute trade: ' + error.message);
        } finally {
          this.disabled = false;
          this.textContent = currentTradeMode === 'buy' ? 'Buy Laam' : 'Sell Laam';
        }
      });
      
      console.log('All event listeners attached successfully');
    });

    // Auto-refresh balance, price, and current tab data every 30 seconds
    setInterval(async () => {
      if (currentKeypair && !document.getElementById('loggedInView').classList.contains('hidden')) {
        await fetchXLMPrice();
        await updateBalanceDisplay();
        
        // Refresh current tab data
        if (currentTab === 'orderbook') {
          await fetchOrderbook();
        } else if (currentTab === 'lastTrades') {
          await fetchTrades();
        } else if (currentTab === 'overview') {
          updateOverview();
        }
      }
    }, 30000);
  </script>
</body>
</html>
